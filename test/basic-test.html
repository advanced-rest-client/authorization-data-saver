<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../../arc-polyfills/arc-polyfills.html">
  <link rel="import" href="../../url/url-polyfill.html">
  <link rel="import" href="../../app-pouchdb/pouchdb.html">
  <link rel="import" href="../../arc-models/auth-data-model.html">
  <link rel="import" href="../../neon-animation/web-animations.html">
  <link rel="import" href="../authorization-data-saver.html">
</head>
<body>
  <auth-data-model></auth-data-model>
  <test-fixture id="basic">
    <template>
      <authorization-data-saver></authorization-data-saver>
    </template>
  </test-fixture>
  <script>
  const initUrl = 'http://domain.com/path/?c=d#hash';
  const cleanUrl = 'http://domain.com/path/';

  function createResponse(authType, status, statusText) {
    status = status || 401;
    statusText = statusText || 'Authorization required';
    let headers = 'x-token: abc\n';
    if (authType === 'ntlm') {
      headers += 'www-authenticate: ntlm';
    } else if (authType === 'basic') {
      headers += 'www-authenticate: basic';
    }
    return {
      status,
      statusText,
      headers,
      payload: 'test'
    };
  }

  function createRequest() {
    return {
      url: initUrl,
      headers: 'x-token: abc',
      method: 'GET'
    };
  }

  const basicObj = {
    username: 'test',
    password: 'test',
    hash: 'dGVzdDp0ZXN0'
  };

  const authObj = {
    username: 'test',
    password: 'test',
    domain: 'domain.com',
    method: 'ntlm'
  };

  suite('basic', function() {
    suite('authorizationMethodFromResponse', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Should not return for not 401 status', function() {
        const response = createResponse('basic', 200, 'OK');
        const method = element.authorizationMethodFromResponse(response);
        assert.isUndefined(method);
      });

      test('Should not return if no www-authenticate header is present', function() {
        const response = createResponse(null, null, {});
        const method = element.authorizationMethodFromResponse(response);
        assert.isUndefined(method);
      });

      test('Should return "basic"', function() {
        const response = createResponse('basic');
        const method = element.authorizationMethodFromResponse(response);
        assert.equal(method, 'basic');
      });

      test('Should return "ntlm"', function() {
        const response = createResponse('ntlm', null, null);
        const method = element.authorizationMethodFromResponse(response);
        assert.equal(method, 'ntlm');
      });

      test('Returns undefined when method is not know', function() {
        const response = createResponse('other', null, null);
        const method = element.authorizationMethodFromResponse(response);
        assert.isUndefined(method);
      });
    });

    suite('_processAuthResponse()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Should open basic dialog', function() {
        const request = createRequest();
        element._processAuthResponse('basic', request);
        assert.equal(element.dialog.nodeName, 'AUTH-DIALOG-BASIC', 'Dialog is auth-dialog-basic');
        assert.isTrue(element.dialog.opened, 'Dialog is opened');
      });

      test('Should open ntlm dialog', function() {
        const request = createRequest();
        element._processAuthResponse('ntlm', request);
        assert.equal(element.dialog.nodeName, 'AUTH-DIALOG-NTLM', 'Dialog is auth-dialog-ntlm');
        assert.isTrue(element.dialog.opened, 'Dialog is opened');
      });

      test('Sets __dialogResultId', function() {
        const request = createRequest();
        element._processAuthResponse('basic', request, 'test-id');
        assert.equal(element.__dialogResultId, 'test-id');
      });

      test('Does nothing when method is missing', function() {
        const request = createRequest();
        element._processAuthResponse(undefined, request, 'test-id');
        assert.isUndefined(element.__dialogResultId);
      });

      test('Does nothing when request is missing', function() {
        element._processAuthResponse('basic', undefined, 'test-id');
        assert.isUndefined(element.__dialogResultId);
      });

      test('Does nothing when request.url is missing', function() {
        const request = createRequest();
        delete request.url;
        element._processAuthResponse('basic', request, 'test-id');
        assert.isUndefined(element.__dialogResultId);
      });
    });

    suite('_cacheAuthData()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Should cache basic data', function() {
        element._cacheAuthData('basic', initUrl, basicObj);
        assert.deepEqual(element._cache.basic[initUrl], basicObj);
      });

      test('Should cache ntlm data', function() {
        element._cacheAuthData('ntlm', initUrl, authObj);
        assert.deepEqual(element._cache.ntlm[initUrl], authObj);
      });
    });

    suite('_findCachedAuthData()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Should not find data for empty cache', function() {
        const auth = element._findCachedAuthData('basic', initUrl);
        assert.isUndefined(auth);
      });

      test('Should not find data in basic map', function() {
        element._cacheAuthData('basic', initUrl, basicObj);
        const auth = element._findCachedAuthData('basic', 'mulesoft.com');
        assert.isUndefined(auth);
      });

      test('Should find data in basic map', function() {
        element._cacheAuthData('basic', cleanUrl, basicObj);
        const auth = element._findCachedAuthData('basic', cleanUrl);
        assert.deepEqual(auth, basicObj);
      });

      test('Should find data in ntlm map', function() {
        element._cacheAuthData('ntlm', cleanUrl, authObj);
        const auth = element._findCachedAuthData('ntlm', cleanUrl);
        assert.deepEqual(auth, authObj);
      });
    });

    suite('_computeUrlPath()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
      });

      test('Computes database key for basic auth', function() {
        const url = element._computeUrlPath(initUrl);
        assert.equal(url, cleanUrl);
      });

      test('Returns empty string when no argument', () => {
        const result = element._computeUrlPath();
        assert.equal(result, '');
      });

      test('Returns passed argument when url is invalid', () => {
        const result = element._computeUrlPath('test');
        assert.equal(result, 'test');
      });
    });

    function authDialogValue(type) {
      const value = {
        username: 'test',
        password: 'test'
      };
      switch (type) {
        case 'basic': value.hash = 'dGVzdDp0ZXN0'; break;
        case 'ntlm': value.domain = 'domain.com'; break;
      }
      return value;
    }

    function createAuthDialogEvent(type) {
      const obj = {
        detail: {
          value: authDialogValue(type),
          type: type,
          cancelled: false
        }
      };
      return obj;
    }

    suite('_onAuthDialogResult()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
        element.url = initUrl;
      });

      test('Processes the dialog results as basic', function() {
        const event = createAuthDialogEvent('basic');
        element._onAuthDialogResult(event);
        // just one of the changes made after calling base auth setter
        assert.ok(element._cache.basic[cleanUrl]);
      });

      test('Processes the dialog results as ntlm', function() {
        const event = createAuthDialogEvent('ntlm');
        element._onAuthDialogResult(event);
        // just one of the changes made after calling ntlm auth setter
        assert.ok(element._cache.ntlm[cleanUrl]);
      });
    });

    suite('_resendRequest()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
        element.url = initUrl;
      });
      test('Fires resend-auth-request event', function() {
        const spy = sinon.spy();
        element.addEventListener('resend-auth-request', spy);
        element._resendRequest();
        assert.isTrue(spy.calledOnce);
      });
    });

    suite('_setNtlmAuthData()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
        element.url = initUrl;
      });

      test('Caches the auth data', function() {
        const value = authDialogValue('ntlm');
        element._setNtlmAuthData(value);
        assert.equal(element._cache.ntlm[cleanUrl], value);
      });

      test('Fires ntlm-data-changed event', function() {
        const spy = sinon.spy();
        element.addEventListener('ntlm-data-changed', spy);
        const value = authDialogValue('ntlm');
        element._setNtlmAuthData(value);
        assert.isTrue(spy.calledOnce);
      });

      test('The ntlm-data-changed event contains auth settings', function(done) {
        const auth = {
          method: 'ntlm'
        };
        element.addEventListener('ntlm-data-changed', function(e) {
          assert.deepEqual(e.detail.value, auth);
          done();
        });
        const value = authDialogValue('ntlm');
        auth.username = value.username;
        auth.password = value.password;
        auth.domain = value.domain;
        element._setNtlmAuthData(value);
      });

      test('Fires resend-auth-request event', function() {
        const spy = sinon.spy();
        element.addEventListener('resend-auth-request', spy);
        const value = authDialogValue('ntlm');
        element._setNtlmAuthData(value);
        assert.isTrue(spy.calledOnce);
      });
    });

    suite('_setBasicAuthData()', function() {
      let element;
      setup(function() {
        element = fixture('basic');
        element.url = initUrl;
      });

      test('Caches the auth data', function() {
        const value = authDialogValue('basic');
        element._setBasicAuthData(value);
        assert.equal(element._cache.basic[cleanUrl], value);
      });

      test('Fires request-header-changed event', function() {
        const spy = sinon.spy();
        element.addEventListener('request-header-changed', spy);
        const value = authDialogValue('basic');
        element._setBasicAuthData(value);
        assert.isTrue(spy.calledOnce);
      });

      test('The request-header-changed event contains header details', function(done) {
        const headerName = 'authorization';
        const headerValue = 'Basic dGVzdDp0ZXN0';
        element.addEventListener('request-header-changed', function(e) {
          assert.equal(e.detail.name, headerName, 'Header name is ok');
          assert.equal(e.detail.value, headerValue, 'Header value is ok');
          done();
        });
        const value = authDialogValue('basic');
        element._setBasicAuthData(value);
      });

      test('Fires resend-auth-request event', function() {
        const spy = sinon.spy();
        element.addEventListener('resend-auth-request', spy);
        const value = authDialogValue('basic');
        element._setBasicAuthData(value);
        assert.isTrue(spy.calledOnce);
      });
    });

    suite('_storeAuthData()', function() {
      let element;
      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
      }
      setup(function() {
        element = fixture('basic');
        element.url = cleanUrl + getRandomInt(1000, 2000) + '/';
      });
      test('Stores auth data for basic', function() {
        return element._storeAuthData('basic', basicObj);
      });

      test('Stores auth data for ntlm', function() {
        return element._storeAuthData('ntlm', authObj);
      });
    });

    suite('_restoreBasicData()', () => {
      let element;
      let doc;
      setup(() => {
        element = fixture('basic');
        element.url = 'http://domain.com';
        element._openBasicAuthDialog(element.url);
        doc = {
          username: 'test',
          password: 'pwd'
        };
      });

      test('Sets username', () => {
        element._restoreBasicData(doc);
        const dialog = element.dialog;
        assert.equal(dialog.username, doc.username);
      });

      test('Sets password', () => {
        element._restoreBasicData(doc);
        const dialog = element.dialog;
        assert.equal(dialog.password, doc.password);
      });
    });

    suite('_restoreNtlmData()', () => {
      let element;
      let doc;
      setup(() => {
        element = fixture('basic');
        element.url = 'http://domain.com';
        element._openNtlmAuthDialog(element.url);
        doc = {
          username: 'test',
          password: 'pwd',
          domain: 'my-domain'
        };
      });

      test('Sets username', () => {
        element._restoreNtlmData(doc);
        const dialog = element.dialog;
        assert.equal(dialog.username, doc.username);
      });

      test('Sets password', () => {
        element._restoreNtlmData(doc);
        const dialog = element.dialog;
        assert.equal(dialog.password, doc.password);
      });

      test('Sets domain', () => {
        element._restoreNtlmData(doc);
        const dialog = element.dialog;
        assert.equal(dialog.domain, doc.domain);
      });
    });

    suite('_setRestoredAuthData()', () => {
      let element;
      setup(() => {
        element = fixture('basic');
        element.url = 'http://domain.com';
      });

      test('Calls _restoreBasicData()', () => {
        element._openBasicAuthDialog(element.url);
        const spy = sinon.spy(element, '_restoreBasicData');
        element._setRestoredAuthData('basic', {});
        assert.isTrue(spy.called);
      });

      test('Calls _restoreNtlmData()', () => {
        element._openNtlmAuthDialog(element.url);
        const spy = sinon.spy(element, '_restoreNtlmData');
        element._setRestoredAuthData('ntlm', {});
        assert.isTrue(spy.called);
      });
    });
  });

  suite('_applyRequestBasicAuthData()', () => {
    let element;
    setup(() => {
      element = fixture('basic');
      element.url = 'http://domain.com';
    });

    test('Dispatches request-headers-changed', () => {
      const spy = sinon.spy();
      element.addEventListener('request-headers-changed', spy);
      element._applyRequestBasicAuthData({}, {
        hash: 'test'
      });
      assert.isTrue(spy.called);
      assert.equal(spy.args[0][0].detail.value, 'authorization: Basic test');
    });

    test('Does nothing if value did not changed', () => {
      const spy = sinon.spy();
      element.addEventListener('request-headers-changed', spy);
      element._applyRequestBasicAuthData({
        headers: 'authorization: Basic test'
      }, {
        hash: 'test'
      });
      assert.isFalse(spy.called);
    });
  });
  </script>
</body>

</html>
